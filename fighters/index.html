<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ˜æœºå¤§æ¯”æ‹¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            background: transparent;
            border-radius: 20px;
            padding: 30px 30px 220px; /* åº•éƒ¨æ·»åŠ è¶³å¤Ÿç©ºé—´å®¹çº³å·²é€‰æˆ˜æœºåŒºåŸŸ */
            box-shadow: none;
            position: relative;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .player-info {
            display: flex;
            gap: 30px;
        }
        
        .player {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        /* ç©å®¶å¤´åƒæ ·å¼ */
        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* ç©å®¶1å¤´åƒ */
        .player1-avatar {
            background-image: url('h66.jpg');
        }
        
        /* ç©å®¶2å¤´åƒ */
        .player2-avatar {
            background-image: url('h77.jpg');
        }
        
        /* è·èƒœè€…å¤´åƒå®¹å™¨æ ·å¼ */
        .winner-avatars {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        /* ç»“æœå¤´åƒæ ·å¼ */
        .result-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4), 0 0 30px rgba(255, 217, 61, 0.6);
            transition: all 0.3s ease;
        }
        
        /* éšè—å¤´åƒ */
        .result-avatar.hide {
            opacity: 0;
            transform: scale(0.5);
        }
        
        /* åˆå§‹è®¾ç½®å¤´åƒ */
        #player1-result-avatar {
            background-image: url('h66.jpg');
        }
        
        #player2-result-avatar {
            background-image: url('h77.jpg');
        }
        
        .score {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .player1 .score {
            color: #ff6b6b;
        }
        
        .player2 .score {
            color: #4ecdc4;
        }
        
        .game-status {
            text-align: center;
            font-size: 1.5rem;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
        }
        
        /* æ¸¸æˆéš¾åº¦é€‰æ‹©æ ·å¼ */
        .game-difficulty {
            text-align: center;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 15px;
        }
        
        .game-difficulty h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: inline-block;
            margin-right: 20px;
        }
        
        .game-size-options {
            display: inline-flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .size-option {
            background: linear-gradient(45deg, #2ed573, #1e90ff);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .size-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 213, 115, 0.4);
        }
        
        .size-option.active {
            background: linear-gradient(45deg, #ff4757, #ffa502);
        }
        
        /* å·²é€‰æˆ˜æœºå±•ç¤ºåŒºåŸŸæ ·å¼ - å›ºå®šåœ¨å±å¹•åº•éƒ¨ */
        .selected-planes {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 0;
            border-radius: 15px 15px 0 0;
            z-index: 100;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        /* å·²é€‰æˆ˜æœºæ¨ªå¹…æ ·å¼ */
        .selected-planes-banner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .selected-planes-banner:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .selected-planes-banner h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        /* åˆ‡æ¢å›¾æ ‡æ ·å¼ */
        .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        /* å·²é€‰æˆ˜æœºå†…å®¹æ ·å¼ */
        .selected-planes-content {
            padding: 0 15px 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* ç§»åŠ¨ç«¯é»˜è®¤éšè—å·²é€‰æˆ˜æœºå†…å®¹ */
        @media screen and (max-device-width: 768px) {
            .selected-planes {
                max-height: 60px; /* ä»…æ˜¾ç¤ºæ¨ªå¹…é«˜åº¦ */
            }
            
            .selected-planes-content {
                display: none;
            }
            
            /* å±•å¼€çŠ¶æ€ */
            .selected-planes.expanded {
                max-height: 200px;
            }
            
            .selected-planes.expanded .selected-planes-content {
                display: block;
            }
            
            .selected-planes.expanded .toggle-icon {
                transform: rotate(180deg);
            }
        }
        
        /* éç§»åŠ¨ç«¯æ˜¾ç¤ºå®Œæ•´å†…å®¹ */
        @media screen and (min-device-width: 769px) {
            .selected-planes-banner {
                display: none; /* éç§»åŠ¨ç«¯éšè—æ¨ªå¹… */
            }
            
            .selected-planes-content {
                display: block;
                padding: 15px;
            }
            
            .selected-planes {
                max-height: 200px;
            }
        }
        

        
        .selected-planes-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }
        
        .player-selected {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .player-label {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .player1-selected .player-label {
            color: #ff6b6b;
        }
        
        .player2-selected .player-label {
            color: #4ecdc4;
        }
        
        .selected-plane-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .selected-plane-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .selected-plane-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .selected-plane-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }
        
        .selected-plane-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-width: 80px;
        }
        
        .selected-plane-item .plane-emoji {
            font-size: 2rem;
            margin: 5px 0;
        }
        
        .selected-plane-item .plane-info {
            font-size: 0.8rem;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .game-container {
                max-width: 100%;
                margin: 0 10px;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .game-container {
                padding: 15px 15px 200px; /* åº•éƒ¨æ·»åŠ è¶³å¤Ÿç©ºé—´å®¹çº³å·²é€‰æˆ˜æœºåŒºåŸŸ */
                margin: 0 5px;
                box-sizing: border-box;
            }
            
            .game-info {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .player-info {
                gap: 15px;
            }
            
            .player {
                min-width: 120px;
                padding: 8px 15px;
            }
            
            .player-avatar {
                width: 60px;
                height: 60px;
            }
            
            .game-status {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .game-difficulty h3 {
                display: block;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .game-size-options {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            /* å·²é€‰æˆ˜æœºåŒºåŸŸä¼˜åŒ– */
            .selected-planes {
                max-height: 180px;
                padding: 10px;
            }
            
            .selected-planes-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .player-selected {
                width: 100%;
                padding: 10px;
            }
            
            .selected-plane-list {
                max-height: 80px;
            }
            
            .selected-plane-item {
                min-width: 70px;
                padding: 8px;
            }
            
            .plane-emoji {
                font-size: 3rem;
            }
            
            .selected-plane-item .plane-emoji {
                font-size: 1.5rem;
            }
            
            .game-board {
                min-height: 500px;
            }
            
            .plane-card {
                width: 80px;
                height: 80px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .game-container {
                padding: 10px 10px 200px; /* åº•éƒ¨æ·»åŠ è¶³å¤Ÿç©ºé—´å®¹çº³å·²é€‰æˆ˜æœºåŒºåŸŸ */
            }
            
            .player-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .player {
                width: 100%;
                max-width: 200px;
            }
            
            .game-status {
                font-size: 1rem;
                padding: 10px;
            }
            
            .game-difficulty {
                padding: 10px;
            }
            
            .size-option {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            .plane-card {
                width: 70px;
                height: 70px;
            }
            
            .plane-emoji {
                font-size: 2.5rem;
            }
            
            .game-board {
                min-height: 400px;
            }
        }
        
        /* é’ˆå¯¹iPhoneç«–å±ä¼˜åŒ– */
        @media screen and (max-device-width: 430px) and (orientation: portrait) {
            /* ä¼˜åŒ–å·²é€‰æˆ˜æœºåŒºåŸŸ */
            .selected-planes {
                padding: 8px;
                max-height: 150px;
            }
            
            .selected-planes-container {
                gap: 8px;
            }
            
            .selected-plane-list {
                max-height: 60px;
            }
            
            .selected-plane-item {
                min-width: 60px;
                padding: 6px;
            }
            
            /* ä¼˜åŒ–å¯¹å†³æ¨¡æ€æ¡† */
            .battle-content {
                padding: 20px 10px;
                width: 95%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .battle-title {
                font-size: 1.8rem;
            }
            
            .battle-planes {
                flex-direction: column;
                gap: 20px;
            }
            
            .battle-plane {
                min-width: auto;
                width: 100%;
                padding: 15px;
            }
            
            .battle-plane-emoji {
                font-size: 3rem;
            }
            
            .versus-text {
                font-size: 2rem;
            }
            
            /* ç¡®ä¿ç»“æœæ¨¡æ€æ¡†é€‚é… */
            .result-content {
                padding: 20px 10px;
                width: 95%;
                max-width: 100%;
            }
        }
        
        /* é’ˆå¯¹iPhoneæ¨ªå±ä¼˜åŒ– */
        @media screen and (max-device-width: 900px) and (orientation: landscape) {
            /* ä¼˜åŒ–æ¸¸æˆå®¹å™¨ */
            .game-container {
                padding: 10px 10px 150px;
            }
            
            /* ä¼˜åŒ–å¯¹å†³æ¨¡æ€æ¡† */
            .battle-modal {
                display: flex;
                align-items: center;
            }
            
            .battle-content {
                padding: 20px;
                width: 95%;
                max-width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .battle-planes {
                gap: 15px;
            }
            
            .battle-plane {
                min-width: 180px;
                padding: 15px;
            }
            
            .battle-plane-emoji {
                font-size: 3.5rem;
            }
            
            /* ç¡®ä¿ç»§ç»­æŒ‰é’®å¯è§ */
            .continue-btn {
                margin-top: 15px;
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            /* ä¼˜åŒ–æ¸¸æˆæ¿ */
            .game-board {
                min-height: 300px;
            }
            
            .plane-card {
                width: 70px;
                height: 70px;
            }
        }
        
        /* é’ˆå¯¹iOSè®¾å¤‡çš„å®‰å…¨åŒºåŸŸä¼˜åŒ– */
        @supports (padding: max(0px)) {
            .selected-planes {
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
            
            .game-container {
                padding-bottom: max(200px, env(safe-area-inset-bottom) + 180px);
            }
        }
        
        /* æ‰‹æœºæ¨ªå±æç¤ºæ ·å¼ */
        .orientation-hint {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            transition: opacity 0.3s ease;
        }
        
        .orientation-content {
            text-align: center;
            color: white;
            padding: 20px;
        }
        
        .orientation-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: rotate 3s ease-in-out infinite;
        }
        
        .orientation-text {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .orientation-subtext {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }
        
        /* åœ¨æ¨ªå±æ¨¡å¼ä¸‹éšè—æç¤º */
        @media screen and (orientation: landscape) {
            .orientation-hint {
                display: none;
            }
        }
        
        /* éæ‰‹æœºè®¾å¤‡éšè—æç¤º */
        @media screen and (min-device-width: 768px) {
            .orientation-hint {
                display: none;
            }
        }
        
        /* æ¸¸æˆæ¿æ ·å¼ */
        .game-board {
            position: relative;
            margin: 20px 0;
            min-height: 500px;
            overflow: hidden;
            border-radius: 15px;
            background: transparent;
            width: 100%;
            z-index: 1;
        }
        
        /* æˆ˜æœºå¡ç‰‡æ ·å¼ - æˆ˜æ–—å ¡å’ */
        .plane-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .plane-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.3);
        }
        
        .plane-card.selected {
            border-color: #ffd93d;
            background: rgba(255, 217, 61, 0.4);
            box-shadow: 0 0 30px rgba(255, 217, 61, 0.6);
        }
        
        .plane-card.revealed {
            background: rgba(78, 205, 196, 0.4);
            cursor: default;
        }
        
        /* æˆ˜æœºå›¾æ ‡æ ·å¼ */
        .plane-emoji {
            font-size: 4rem;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        /* æˆ˜æ–—å ¡å’ï¼ˆå¤ªç©ºèˆ±ï¼‰æ ·å¼ */
        .plane-card:not(.revealed) .plane-emoji {
            filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.8));
        }
        
        /* ä¸åŒç­‰çº§æˆ˜æœºçš„emoji */
        .level-1 .plane-emoji { content: 'ğŸ›©ï¸'; }
        .level-2 .plane-emoji { content: 'âœˆï¸'; }
        .level-3 .plane-emoji { content: 'ğŸš'; }
        .level-4 .plane-emoji { content: 'ğŸ›«'; }
        .level-5 .plane-emoji { content: 'ğŸ›¬'; }
        .level-6 .plane-emoji { content: 'ğŸ§¨'; }
        .level-7 .plane-emoji { content: 'ğŸ’£'; }
        .level-8 .plane-emoji { content: 'ğŸš€'; }
        .level-9 .plane-emoji { content: 'ğŸ›¸'; }
        .level-10 .plane-emoji { content: 'ğŸ‘¾'; }
        
        .plane-health {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .plane-level {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        /* å¯¹å†³æ¨¡æ€æ¡†æ ·å¼ */
        .battle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .battle-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 900px;
            width: 95%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .battle-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        .battle-planes {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 40px;
            margin: 30px 0;
        }
        
        .battle-plane {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            min-width: 250px;
        }
        
        .battle-plane-emoji {
            font-size: 5rem;
            margin: 20px auto;
        }
        
        /* ä¸åŒç­‰çº§æˆ˜æœºçš„emoji */
        .level-1.battle-plane-emoji::before { content: 'ğŸ›©ï¸'; }
        .level-2.battle-plane-emoji::before { content: 'âœˆï¸'; }
        .level-3.battle-plane-emoji::before { content: 'ğŸš'; }
        .level-4.battle-plane-emoji::before { content: 'ğŸ›«'; }
        .level-5.battle-plane-emoji::before { content: 'ğŸ›¬'; }
        .level-6.battle-plane-emoji::before { content: 'ğŸ§¨'; }
        .level-7.battle-plane-emoji::before { content: 'ğŸ’£'; }
        .level-8.battle-plane-emoji::before { content: 'ğŸš€'; }
        .level-9.battle-plane-emoji::before { content: 'ğŸ›¸'; }
        .level-10.battle-plane-emoji::before { content: 'ğŸ‘¾'; }
        
        .health-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757 0%, #ffa502 50%, #2ed573 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .versus-text {
            font-size: 3rem;
            font-weight: bold;
            color: #ffd93d;
        }
        
        .battle-result {
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .continue-btn {
            background: linear-gradient(45deg, #2ed573 0%, #1e90ff 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 213, 115, 0.4);
        }
        
        /* å‡»æ¯åŠ¨ç”»æ•ˆæœ */
        /* å¯¼å¼¹é£è¡ŒåŠ¨ç”» */
        @keyframes missile {
            0% { 
                opacity: 1;
                transform: scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
            100% { 
                opacity: 0;
                transform: scale(1) rotate(360deg);
            }
        }
        
        /* ç °åœ°ä¸€å£°çˆ†ç‚¸åŠ¨ç”» */
        @keyframes explode {
            0% { 
                transform: scale(1); 
                opacity: 1;
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(255, 71, 87, 0);
            }
            50% { 
                transform: scale(1.2); 
                opacity: 1;
                filter: brightness(3);
                box-shadow: 0 0 40px #ff4757, 0 0 80px #ff4757, 0 0 120px #ff4757, 0 0 160px #ff4757;
            }
            100% { 
                transform: scale(1); 
                opacity: 0;
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(255, 71, 87, 0);
            }
        }
        
        /* é£æœºæ¶ˆå¤±åŠ¨ç”» */
        @keyframes disappear {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0);
            }
        }
        
        /* éœ‡åŠ¨åŠ¨ç”» */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        /* å¯¼å¼¹æ ·å¼ - æ›´çœŸå®çš„å¯¼å¼¹å¤–è§‚ */
        .missile {
            position: absolute;
            width: 60px;
            height: 12px;
            background: linear-gradient(to right, #333, #666);
            border-radius: 6px 0 0 6px;
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 217, 61, 0.8);
        }
        
        /* å¯¼å¼¹å¤´éƒ¨ */
        .missile::before {
            content: '';
            position: absolute;
            right: -15px;
            top: 0;
            width: 0;
            height: 0;
            border-left: 15px solid #333;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        
        /* å¯¼å¼¹å°¾ç¿¼ */
        .missile::after {
            content: '';
            position: absolute;
            left: -5px;
            top: -8px;
            width: 10px;
            height: 6px;
            background: #555;
            border-radius: 3px;
            box-shadow: 0 14px 0 #555;
        }
        
        /* å¯¼å¼¹å°¾éƒ¨ç«ç„° */
        .missile-fly::after {
            content: '';
            position: absolute;
            left: -15px;
            top: 2px;
            width: 15px;
            height: 8px;
            background: linear-gradient(to left, #ffd93d, #ff4757);
            border-radius: 50% 0 0 50%;
            animation: missile-flame 0.1s infinite alternate;
        }
        
        /* å¯¼å¼¹ç«ç„°åŠ¨ç”» */
        @keyframes missile-flame {
            0% {
                opacity: 0.8;
                transform: scaleX(1);
            }
            100% {
                opacity: 1;
                transform: scaleX(1.2);
            }
        }
        
        /* å¯¼å¼¹é£è¡Œè·¯å¾„åŠ¨ç”» - ä½¿ç”¨transformå®ç°æŠ›ç‰©çº¿è½¨è¿¹ */
        .missile-fly {
            animation: missile-fly 1s ease-in forwards;
        }
        
        @keyframes missile-fly {
            0% { 
                opacity: 1;
                transform: translateX(0) translateY(0) scale(0.5) rotate(var(--rotation));
            }
            25% {
                opacity: 1;
                transform: translateX(calc(var(--end-x) * 0.25)) translateY(calc(var(--end-y) * 0.25 - 20px)) scale(0.7) rotate(var(--rotation));
            }
            50% {
                opacity: 1;
                transform: translateX(calc(var(--end-x) * 0.5)) translateY(calc(var(--end-y) * 0.5 - 30px)) scale(0.85) rotate(var(--rotation));
            }
            75% {
                opacity: 1;
                transform: translateX(calc(var(--end-x) * 0.75)) translateY(calc(var(--end-y) * 0.75 - 15px)) scale(0.95) rotate(var(--rotation));
            }
            100% { 
                opacity: 0;
                transform: translateX(var(--end-x)) translateY(var(--end-y)) scale(1) rotate(var(--rotation));
            }
        }
        
        /* çˆ†ç‚¸åŠ¨ç”» */
        .plane-explode {
            animation: explode 0.8s ease-out forwards;
        }
        
        /* é£æœºæ¶ˆå¤±åŠ¨ç”» */
        .plane-disappear {
            animation: disappear 0.8s ease-out forwards;
        }
        
        /* éœ‡åŠ¨åŠ¨ç”» */
        .plane-shake {
            animation: shake 0.2s ease-in-out infinite;
        }
        
        /* ç»“æœæ¨¡æ€æ¡†æ ·å¼ */
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .result-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        /* æˆ˜å†µè¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
        .battle-records-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .battle-records-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* æˆ˜å†µè¯¦æƒ…åˆ—è¡¨æ ·å¼ */
        .battle-records-list {
            margin: 20px 0;
            text-align: left;
        }
        
        /* æ¯è½®æˆ˜å†µæ ·å¼ */
        .round-record {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
        }
        
        /* è½®æ¬¡æ ‡é¢˜ */
        .round-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            color: #ffd93d;
        }
        
        /* ç©å®¶é€‰æ‹©æ ·å¼ */
        .player-selections {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 10px;
        }
        
        /* å•ä¸ªç©å®¶é€‰æ‹©æ ·å¼ */
        .player-selection {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }
        
        /* ç©å®¶åç§° */
        .player-selection .player-name {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        /* æˆ˜æœºä¿¡æ¯ */
        .plane-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* æˆ˜æœºè¡¨æƒ… */
        .plane-info .plane-emoji {
            font-size: 2rem;
        }
        
        /* æˆ˜æœºè¯¦æƒ… */
        .plane-details {
            text-align: left;
        }
        
        /* æŒ‰é’®å®¹å™¨ */
        .battle-records-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .player-selections {
                flex-direction: column;
            }
            
            .battle-records-buttons {
                flex-direction: column;
            }
        }
        
        .hide {
            display: none;
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div class="game-container">
        <h1>æˆ˜æœºå¤§æ¯”æ‹¼</h1>
        
        <!-- æ¸¸æˆéš¾åº¦é€‰æ‹© -->
        <div class="game-difficulty">
            <h3>æˆ˜æœºæ€»æ•°:</h3>
            <div class="game-size-options">
                <button class="size-option" data-planes="10">10æ¶</button>
                <button class="size-option" data-planes="20">20æ¶</button>
                <button class="size-option" data-planes="30">30æ¶</button>
                <button class="size-option" data-planes="40">40æ¶</button>
                <button class="size-option" data-planes="50">50æ¶</button>
            </div>
        </div>
        
        <div class="game-info">
            <div class="player-info">
                <div class="player player1">
                    <div class="player-avatar player1-avatar"></div>
                    <div>66å°æœ‹å‹</div>
                    <div class="score" id="player1-score">0</div>
                </div>
                <div class="player player2">
                    <div class="player-avatar player2-avatar"></div>
                    <div>77å°æœ‹å‹</div>
                    <div class="score" id="player2-score">0</div>
                </div>
            </div>
            <div class="round-info">
                è½®æ¬¡: <span id="round-count">0</span>
            </div>
        </div>
        
        <div class="game-status" id="game-status">ç©å®¶1ï¼Œè¯·é€‰æ‹©ä½ çš„æˆ˜æœº</div>
        
        <!-- å·²é€‰æˆ˜æœºå±•ç¤ºåŒºåŸŸ -->
        <div class="selected-planes">
            <!-- å·²é€‰æˆ˜æœºæ¨ªå¹…ï¼ˆç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ -->
            <div class="selected-planes-banner" id="selected-planes-banner">
                <h3>å·²é€‰æˆ˜æœº</h3>
                <span class="toggle-icon">â–¼</span>
            </div>
            <!-- å·²é€‰æˆ˜æœºå†…å®¹ -->
            <div class="selected-planes-content" id="selected-planes-content">
                <div class="selected-planes-container">
                    <div class="player-selected player1-selected">
                        <div class="player-label">66å°æœ‹å‹å·²é€‰</div>
                        <div class="selected-plane-list" id="player1-selected-list"></div>
                    </div>
                    <div class="player-selected player2-selected">
                        <div class="player-label">77å°æœ‹å‹å·²é€‰</div>
                        <div class="selected-plane-list" id="player2-selected-list"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŠ¨æ€å¤§å°çš„æ¸¸æˆæ¿ -->
        <div class="game-board" id="game-board"></div>
        
        <!-- éŸ³é¢‘å…ƒç´  -->
        <audio id="victory-music" preload="auto">
            <source src="victory.mp3" type="audio/mpeg">
            <!-- æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼ä»¥æé«˜æµè§ˆå™¨å…¼å®¹æ€§ -->
        </audio>
        
        <!-- æ‰‹æœºæ¨ªå±æç¤º -->
        <div id="orientation-hint" class="orientation-hint">
            <div class="orientation-content">
                <div class="orientation-icon">ğŸ“±</div>
                <div class="orientation-text">ä¸ºè·å¾—æœ€ä½³ä½“éªŒï¼Œè¯·å°†æ‰‹æœºæ¨ªå±ä½¿ç”¨</div>
                <div class="orientation-subtext">Rotate your device to landscape mode for the best experience</div>
            </div>
        </div>

    </div>
    
    <!-- å¯¹å†³æ¨¡æ€æ¡† -->
    <div class="battle-modal hide" id="battle-modal">
        <div class="battle-content">
            <h2 class="battle-title">ğŸš¨ æˆ˜æœºå¯¹å†³ ğŸš¨</h2>
            <div class="battle-planes" style="position: relative;">
                <!-- 66å°æœ‹å‹é£æœº -->
                <div class="battle-plane" style="position: relative; z-index: 5;">
                    <div>66å°æœ‹å‹</div>
                    <div id="battle-emoji1" style="font-size: 5rem; margin: 20px auto;"></div>
                    <div id="battle-name1"></div>
                    <div class="health-bar">
                        <div class="health-fill" id="health-fill1" style="width: 50%"></div>
                    </div>
                    <div id="health-value1"></div>
                </div>
                
                <!-- æ¿€å…‰æŸå®¹å™¨ -->
                <div id="laser-container" style="position: absolute; top: 50%; left: 0; right: 0; height: 4px; pointer-events: none; z-index: 10;"></div>
                
                <div class="versus-text">VS</div>
                
                <!-- 77å°æœ‹å‹é£æœº -->
                <div class="battle-plane" style="position: relative; z-index: 5;">
                    <div>77å°æœ‹å‹</div>
                    <div id="battle-emoji2" style="font-size: 5rem; margin: 20px auto;"></div>
                    <div id="battle-name2"></div>
                    <div class="health-bar">
                        <div class="health-fill" id="health-fill2" style="width: 50%"></div>
                    </div>
                    <div id="health-value2"></div>
                </div>
            </div>
            
            <div class="battle-result" id="battle-result"></div>
            <button class="continue-btn hide" id="continue-btn">ç»§ç»­æ¸¸æˆ</button>
        </div>
    </div>
    
    <!-- ç»“æœæ¨¡æ€æ¡† -->
        <div class="result-modal hide" id="result-modal">
            <div class="result-content">
                <!-- è·èƒœè€…å¤´åƒå®¹å™¨ -->
                <div class="winner-avatars">
                    <div id="player1-result-avatar" class="result-avatar"></div>
                    <div id="player2-result-avatar" class="result-avatar"></div>
                </div>
                <h2 id="result-title">æ¸¸æˆç»“æŸ</h2>
                <p id="result-text"></p>
                <button class="continue-btn" id="view-battle-records">æŸ¥çœ‹æˆ˜å†µ</button>
            </div>
        </div>
        
        <!-- æˆ˜å†µè¯¦æƒ…æ¨¡æ€æ¡† -->
        <div class="battle-records-modal hide" id="battle-records-modal">
            <div class="battle-records-content">
                <h2>æˆ˜å†µè¯¦æƒ…</h2>
                <div class="battle-records-list" id="battle-records-list"></div>
                <div class="battle-records-buttons">
                    <button class="continue-btn" id="play-again-from-records">å†æ¥ä¸€å±€</button>
                    <button class="continue-btn" id="end-game">ç»“æŸæ¸¸æˆ</button>
                </div>
            </div>
        </div>
    
    <script>

        
        // æ¸¸æˆæ•°æ®
        const planes = [
            { emoji: 'ğŸ›©ï¸', health: 10, name: 'è½»å‹æˆ˜æ–—æœº', level: 1 },
            { emoji: 'âœˆï¸', health: 20, name: 'ä¸­å‹æˆ˜æ–—æœº', level: 2 },
            { emoji: 'ğŸš', health: 30, name: 'ç›´å‡æœº', level: 3 },
            { emoji: 'ğŸ›«', health: 40, name: 'èµ·é£æˆ˜æœº', level: 4 },
            { emoji: 'ğŸ›¬', health: 50, name: 'é™è½æˆ˜æœº', level: 5 },
            { emoji: 'ğŸ§¨', health: 60, name: 'è½°ç‚¸æœº', level: 6 },
            { emoji: 'ğŸ’£', health: 70, name: 'æ”»å‡»æœº', level: 7 },
            { emoji: 'ğŸš€', health: 80, name: 'ç«ç®­æˆ˜æœº', level: 8 },
            { emoji: 'ğŸ›¸', health: 90, name: 'é£ç¢Ÿ', level: 9 },
            { emoji: 'ğŸ‘¾', health: 100, name: 'å¤–æ˜Ÿæˆ˜æœº', level: 10 }
        ];
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            board: [],
            player1Score: 0,
            player2Score: 0,
            currentPlayer: 1,
            firstPlayer: 1, // è®°å½•æ¯è½®çš„å…ˆæ‰‹ç©å®¶
            selectedPlanes: [],
            roundCount: 0,
            revealedCount: 0,
            totalPlanes: 40,
            boardSize: 4,
            player1SelectedPlanes: [], // ç©å®¶1å·²é€‰æˆ˜æœº
            player2SelectedPlanes: []  // ç©å®¶2å·²é€‰æˆ˜æœº
        };
        
        // åˆå§‹åŒ–æ¸¸æˆæ¿
        function initBoard(totalPlanes = 10) {
            const board = [];
            // è®¡ç®—åˆé€‚çš„ç½‘æ ¼å¤§å°ï¼Œç¡®ä¿ç½‘æ ¼å¤§å°ä¸ºå¶æ•°ä¸”èƒ½å®¹çº³æ‰€æœ‰æˆ˜æœº
            let boardSize = Math.ceil(Math.sqrt(totalPlanes));
            // ç¡®ä¿boardSizeä¸ºå¶æ•°
            if (boardSize % 2 !== 0) {
                boardSize++;
            }
            
            // åˆ›å»ºå¯¹åº”åˆ—æ•°ï¼Œæ¯åˆ—å¯¹åº”è¡Œæ•°
            for (let col = 0; col < boardSize; col++) {
                const column = [];
                
                for (let row = 0; row < boardSize; row++) {
                    column.push({
                        // é»˜è®¤éšè—çŠ¶æ€
                        revealed: false,
                        selected: false
                    });
                }
                board.push(column);
            }
            
            // å¡«å……æˆ˜æœº
            let planesAdded = 0;
            while (planesAdded < totalPlanes) {
                const col = Math.floor(Math.random() * boardSize);
                const row = Math.floor(Math.random() * boardSize);
                
                // å¦‚æœè¯¥ä½ç½®è¿˜æ²¡æœ‰æˆ˜æœºï¼Œæ·»åŠ ä¸€ä¸ª
                if (!board[col][row].emoji) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªæˆ˜æœº
                    const randomPlane = planes[Math.floor(Math.random() * planes.length)];
                    board[col][row] = {
                        ...randomPlane,
                        revealed: false,
                        selected: false
                    };
                    planesAdded++;
                }
            }
            
            return board;
        }
        
        // æ¸²æŸ“å·²é€‰æˆ˜æœº
        function renderSelectedPlanes() {
            const player1List = document.getElementById('player1-selected-list');
            const player2List = document.getElementById('player2-selected-list');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            player1List.innerHTML = '';
            player2List.innerHTML = '';
            
            // æ¸²æŸ“ç©å®¶1å·²é€‰æˆ˜æœº
            gameState.player1SelectedPlanes.forEach((plane, index) => {
                const planeItem = document.createElement('div');
                planeItem.className = 'selected-plane-item';
                planeItem.innerHTML = `
                    <div class="plane-emoji">${plane.emoji}</div>
                    <div class="plane-info">
                        <div>${plane.name}</div>
                        <div>è¡€é‡: ${plane.health}</div>
                        <div>ç¬¬${index + 1}è½®</div>
                    </div>
                `;
                player1List.appendChild(planeItem);
            });
            
            // æ¸²æŸ“ç©å®¶2å·²é€‰æˆ˜æœº
            gameState.player2SelectedPlanes.forEach((plane, index) => {
                const planeItem = document.createElement('div');
                planeItem.className = 'selected-plane-item';
                planeItem.innerHTML = `
                    <div class="plane-emoji">${plane.emoji}</div>
                    <div class="plane-info">
                        <div>${plane.name}</div>
                        <div>è¡€é‡: ${plane.health}</div>
                        <div>ç¬¬${index + 1}è½®</div>
                    </div>
                `;
                player2List.appendChild(planeItem);
            });
        }
        
        // æ¸²æŸ“æ¸¸æˆæ¿
        function renderBoard() {
            const gameBoard = document.getElementById('game-board');
            const boardSize = gameState.boardSize;
            
            // æ¸…é™¤ç°æœ‰çš„æ¸¸æˆæ¿å†…å®¹
            gameBoard.innerHTML = '';
            
            // ä¿®æ”¹æ¸¸æˆæ¿æ ·å¼ï¼Œæ”¹ä¸ºç›¸å¯¹å®šä½ï¼Œè®©æˆ˜æ–—å ¡å’å¯ä»¥ç»å¯¹å®šä½
            gameBoard.style.position = 'relative';
            gameBoard.style.minHeight = '500px';
            gameBoard.style.gridTemplateColumns = 'none';
            
            // éå†æ¸¸æˆæ¿ï¼Œæ¸²æŸ“æ¯ä¸ªæˆ˜æ–—å ¡å’
            gameState.board.forEach((column, colIndex) => {
                column.forEach((plane, rowIndex) => {
                    // åªæ¸²æŸ“æœ‰æˆ˜æœºçš„ä½ç½®
                    if (plane.emoji) {
                        const card = document.createElement('div');
                        card.className = `plane-card level-${plane.level}`;
                        
                        if (plane.revealed) {
                            card.classList.add('revealed');
                        }
                        
                        if (plane.selected) {
                            card.classList.add('selected');
                        }
                        
                        // è®¾ç½®å¡ç‰‡ä¸ºç»å¯¹å®šä½
                        card.style.position = 'absolute';
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä½ç½®ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆ
                        if (!plane.position) {
                            // æˆ˜æœºå¡ç‰‡å¤§å°
                            const planeSize = 100;
                            // éšæœºç”Ÿæˆä½ç½®ï¼Œç¡®ä¿æ•´ä¸ªæˆ˜æœºéƒ½åœ¨æ¸¸æˆæ¿å†…
                            const x = Math.random() * (gameBoard.clientWidth - planeSize);
                            const y = Math.random() * (gameBoard.clientHeight - planeSize);
                            // ä¿å­˜ä½ç½®ä¿¡æ¯ï¼Œç¡®ä¿æ¯è½®ä¸­ä¸æ”¹å˜
                            plane.position = { x, y };
                        }
                        
                        // ä½¿ç”¨ä¿å­˜çš„ä½ç½®
                        card.style.left = `${plane.position.x}px`;
                        card.style.top = `${plane.position.y}px`;
                        
                        // é™åˆ¶å¡ç‰‡å¤§å°
                        card.style.width = '100px';
                        card.style.height = '100px';
                        
                        // å¡ç‰‡å†…å®¹
                        let cardContent = '';
                        if (plane.revealed) {
                            cardContent = `
                                <div class="plane-emoji">${plane.emoji}</div>
                                <div class="plane-health">${plane.health}</div>
                                <div class="plane-level">Lv.${plane.level}</div>
                            `;
                        } else {
                            // ä½¿ç”¨å¤ªç©ºèˆ±æ ‡å¿—ä½œä¸ºæˆ˜æ–—å ¡å’
                            cardContent = '<div class="plane-emoji">ğŸ›¸</div>';
                        }
                        
                        card.innerHTML = cardContent;
                        card.dataset.col = colIndex;
                        card.dataset.row = rowIndex;
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        card.addEventListener('click', () => handleCardClick(colIndex, rowIndex));
                        
                        gameBoard.appendChild(card);
                    }
                });
            });
        }
        
        // å¤„ç†å¡ç‰‡ç‚¹å‡»
        function handleCardClick(col, row) {
            const plane = gameState.board[col][row];
            
            // å¦‚æœå¡ç‰‡å·²æ­ç¤ºï¼Œä¸èƒ½å†æ¬¡é€‰æ‹©
            if (plane.revealed) {
                return;
            }
            
            // å¦‚æœå¡ç‰‡å·²è¢«é€‰ä¸­ï¼Œä¸èƒ½å†æ¬¡é€‰æ‹©
            if (plane.selected) {
                return;
            }
            
            // é€‰æ‹©å¡ç‰‡
            plane.selected = true;
            // è®°å½•å½“å‰ç©å®¶IDï¼Œç”¨äºåç»­åˆ¤æ–­èƒœè´Ÿ
            gameState.selectedPlanes.push({ col, row, plane, playerId: gameState.currentPlayer });
            
            // æ›´æ–°ç•Œé¢
            renderBoard();
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªç©å®¶é€‰æ‹©äº†é£æœºï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªç©å®¶
            if (gameState.selectedPlanes.length === 1) {
                // åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç©å®¶
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                // æ›´æ–°æ¸¸æˆçŠ¶æ€æ–‡æœ¬
                const playerName = gameState.currentPlayer === 1 ? '66å°æœ‹å‹' : '77å°æœ‹å‹';
                document.getElementById('game-status').textContent = `${playerName}ï¼Œè¯·é€‰æ‹©ä½ çš„æˆ˜æœº`;
                console.log('ç©å®¶åˆ‡æ¢æˆåŠŸï¼Œå½“å‰ç©å®¶:', gameState.currentPlayer, 'æ˜¾ç¤ºæ–‡æœ¬:', document.getElementById('game-status').textContent);
            } else {
                // ä¸¤ä¸ªç©å®¶éƒ½å·²é€‰æ‹©ï¼Œæ˜¾ç¤ºå¯¹å†³ç”»é¢
                setTimeout(() => {
                    showBattleScreen();
                }, 1000);
            }
        }
        
        // æ˜¾ç¤ºå¯¹å†³ç”»é¢
        function showBattleScreen() {
            // ç¡®å®šå“ªä¸ªæ˜¯ç©å®¶1çš„é€‰æ‹©ï¼Œå“ªä¸ªæ˜¯ç©å®¶2çš„é€‰æ‹©
            const player1Selection = gameState.selectedPlanes.find(selection => selection.playerId === 1);
            const player2Selection = gameState.selectedPlanes.find(selection => selection.playerId === 2);
            
            const modal = document.getElementById('battle-modal');
            const continueBtn = document.getElementById('continue-btn');
            const laserContainer = document.getElementById('laser-container');
            
            // é‡ç½®çŠ¶æ€
            continueBtn.classList.add('hide');
            laserContainer.innerHTML = '';
            
            // è®¾ç½®ç©å®¶1é£æœºä¿¡æ¯
            const emoji1 = document.getElementById('battle-emoji1');
            emoji1.textContent = player1Selection.plane.emoji;
            document.getElementById('battle-name1').textContent = player1Selection.plane.name;
            const healthFill1 = document.getElementById('health-fill1');
            const healthPercent1 = (player1Selection.plane.health / 100) * 100;
            healthFill1.style.width = `${healthPercent1}%`;
            healthFill1.textContent = player1Selection.plane.health;
            document.getElementById('health-value1').textContent = `${player1Selection.plane.health} è¡€é‡`;
            
            // è®¾ç½®ç©å®¶2é£æœºä¿¡æ¯
            const emoji2 = document.getElementById('battle-emoji2');
            emoji2.textContent = player2Selection.plane.emoji;
            document.getElementById('battle-name2').textContent = player2Selection.plane.name;
            const healthFill2 = document.getElementById('health-fill2');
            const healthPercent2 = (player2Selection.plane.health / 100) * 100;
            healthFill2.style.width = `${healthPercent2}%`;
            healthFill2.textContent = player2Selection.plane.health;
            document.getElementById('health-value2').textContent = `${player2Selection.plane.health} è¡€é‡`;
            
            // æ˜¾ç¤ºå¯¹å†³æ¨¡æ€æ¡†
            modal.classList.remove('hide');
            
            // å»¶è¿Ÿåå¼€å§‹æˆ˜æ–—åŠ¨ç”»
            setTimeout(() => {
                const resultElement = document.getElementById('battle-result');
                let resultText = '';
                let winner, loser, winnerEmoji, loserEmoji;
                
                // æ¯”è¾ƒè¡€é‡
                if (player1Selection.plane.health > player2Selection.plane.health) {
                    gameState.player1Score++;
                    resultText = 'ğŸ‰ 66å°æœ‹å‹è·èƒœï¼';
                    winner = player1Selection;
                    loser = player2Selection;
                    winnerEmoji = emoji1;
                    loserEmoji = emoji2;
                } else if (player1Selection.plane.health < player2Selection.plane.health) {
                    gameState.player2Score++;
                    resultText = 'ğŸ‰ 77å°æœ‹å‹è·èƒœï¼';
                    winner = player2Selection;
                    loser = player1Selection;
                    winnerEmoji = emoji2;
                    loserEmoji = emoji1;
                } else {
                    resultText = 'ğŸ¤ å¹³å±€ï¼';
                }
                
                // å¦‚æœä¸æ˜¯å¹³å±€ï¼Œæ’­æ”¾æˆ˜æ–—åŠ¨ç”»
                if (winner && loser) {
                    // 1. è°ƒæ•´å¯¼å¼¹å®¹å™¨ä½ç½®å’Œæ ·å¼
                    laserContainer.style.height = '100px';
                    
                    // 2. è·å–é£æœºå…ƒç´ çš„ä½ç½®
                    const winnerEmojiRect = winnerEmoji.getBoundingClientRect();
                    const loserEmojiRect = loserEmoji.getBoundingClientRect();
                    const containerRect = laserContainer.getBoundingClientRect();
                    
                    // 3. è®¡ç®—å¯¼å¼¹çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼ˆç›¸å¯¹äºå®¹å™¨ï¼‰
                    // å¯¼å¼¹å®½åº¦60pxï¼Œé«˜åº¦12px
                    const startX = winner === player1Selection ? winnerEmojiRect.right - containerRect.left : winnerEmojiRect.left - containerRect.left - 60;
                    const startY = (winnerEmojiRect.top + winnerEmojiRect.bottom) / 2 - containerRect.top - 6;
                    const endX = winner === player1Selection ? loserEmojiRect.left - containerRect.left : loserEmojiRect.right - containerRect.left - 60;
                    const endY = (loserEmojiRect.top + loserEmojiRect.bottom) / 2 - containerRect.top - 6;
                    
                    // 4. è®¡ç®—ä¸­é—´ç‚¹
                    const midX = (startX + endX) / 2;
                    const midY = (startY + endY) / 2;
                    
                    // 5. æ·»åŠ å¯¼å¼¹
                    const missile = document.createElement('div');
                    missile.className = 'missile missile-fly';
                    
                    // è®¾ç½®å¯¼å¼¹åˆå§‹ä½ç½®
                    missile.style.left = `${startX}px`;
                    missile.style.top = `${startY}px`;
                    
                    // è®¾ç½®CSSå˜é‡ç”¨äºåŠ¨ç”»
                    missile.style.setProperty('--mid-x', `${midX - startX}px`);
                    missile.style.setProperty('--mid-y', `${midY - startY}px`);
                    missile.style.setProperty('--end-x', `${endX - startX}px`);
                    missile.style.setProperty('--end-y', `${endY - startY}px`);
                    
                    // è®¾ç½®å¯¼å¼¹æ—‹è½¬è§’åº¦ï¼Œä½¿å…¶æŒ‡å‘ç›®æ ‡
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    missile.style.transform = `translateX(0) translateY(0) scale(0.5) rotate(${angle}deg)`;
                    // åŠ¨ç”»è¿‡ç¨‹ä¸­ä¿æŒæ—‹è½¬è§’åº¦ä¸å˜
                    missile.style.setProperty('--rotation', `${angle}deg`);
                    
                    laserContainer.appendChild(missile);
                    
                    // 6. èƒœåˆ©è€…éœ‡åŠ¨
                    winnerEmoji.classList.add('plane-shake');
                    
                    // 7. å»¶è¿Ÿåå¤±è´¥è€…çˆ†ç‚¸ï¼ˆè®©å¯¼å¼¹åŠ¨ç”»å®Œæ•´æ’­æ”¾ï¼‰
                    setTimeout(() => {
                        // ç§»é™¤éœ‡åŠ¨æ•ˆæœ
                        winnerEmoji.classList.remove('plane-shake');
                        
                        // ç§»é™¤å¯¼å¼¹
                        missile.remove();
                        
                        // å¤±è´¥è€…çˆ†ç‚¸ï¼ˆç °åœ°ä¸€å£°ï¼‰
                        loserEmoji.classList.add('plane-explode');
                        
                        // 8. çˆ†ç‚¸åæ¶ˆå¤±ï¼Œç„¶åæ˜¾ç¤ºç»“æœ
                        setTimeout(() => {
                            // å…ˆè®©å¤±è´¥è€…é£æœºæ¶ˆå¤±
                            loserEmoji.classList.add('plane-disappear');
                            
                            // 9. æ˜¾ç¤ºç»“æœ
                            setTimeout(() => {
                                resultElement.textContent = resultText;
                                
                                // 10. æ›´æ–°åˆ†æ•°
                                document.getElementById('player1-score').textContent = gameState.player1Score;
                                document.getElementById('player2-score').textContent = gameState.player2Score;
                                
                                // 11. æ˜¾ç¤ºç»§ç»­æŒ‰é’®
                                continueBtn.classList.remove('hide');
                            }, 800); // åŒ¹é…æ¶ˆå¤±åŠ¨ç”»æ—¶é•¿
                        }, 800); // åŒ¹é…çˆ†ç‚¸åŠ¨ç”»æ—¶é•¿
                    }, 1200); // åŒ¹é…å¯¼å¼¹åŠ¨ç”»æ—¶é•¿
                } else {
                    // å¹³å±€æƒ…å†µ
                    resultElement.textContent = resultText;
                    document.getElementById('player1-score').textContent = gameState.player1Score;
                    document.getElementById('player2-score').textContent = gameState.player2Score;
                    continueBtn.classList.remove('hide');
                }
            }, 1000);
        }
        
        // ç»§ç»­æ¸¸æˆ
        function continueGame() {
            const modal = document.getElementById('battle-modal');
            modal.classList.add('hide');
            
            // é‡ç½®åŠ¨ç”»çŠ¶æ€
            const emoji1 = document.getElementById('battle-emoji1');
            const emoji2 = document.getElementById('battle-emoji2');
            emoji1.classList.remove('plane-shake', 'plane-explode', 'plane-disappear');
            emoji2.classList.remove('plane-shake', 'plane-explode', 'plane-disappear');
            document.getElementById('laser-container').innerHTML = '';
            document.getElementById('battle-result').textContent = '';
            
            // ä¿å­˜å½“å‰è½®æ¬¡çš„é€‰æ‹©ç»“æœï¼Œç”¨äºåˆ¤æ–­èƒœè€…
            const currentSelections = [...gameState.selectedPlanes];
            
            // ä¸‹ä¸€è½®çš„å…ˆæ‰‹ç”±ä¸Šä¸€è½®èƒœè€…å†³å®š
            // åœ¨ä¿®æ”¹æˆ˜æœºå¯¹è±¡å‰å…ˆåˆ¤æ–­èƒœè´Ÿ
            let nextPlayer = 1; // é»˜è®¤ç©å®¶1å…ˆæ‰‹
            
            if (currentSelections.length === 2) {
                // ç¡®å®šå“ªä¸ªæ˜¯ç©å®¶1çš„é€‰æ‹©ï¼Œå“ªä¸ªæ˜¯ç©å®¶2çš„é€‰æ‹©
                const player1Selection = currentSelections.find(selection => selection.playerId === 1);
                const player2Selection = currentSelections.find(selection => selection.playerId === 2);
                
                if (player1Selection && player2Selection) {
                    // æ¯”è¾ƒè¡€é‡åˆ¤æ–­èƒœè´Ÿ
                    if (player1Selection.plane.health > player2Selection.plane.health) {
                        // ç©å®¶1ï¼ˆ66å°æœ‹å‹ï¼‰èƒœåˆ©ï¼Œä¸‹ä¸€è½®ç©å®¶1å…ˆæ‰‹
                        nextPlayer = 1;
                    } else if (player1Selection.plane.health < player2Selection.plane.health) {
                        // ç©å®¶2ï¼ˆ77å°æœ‹å‹ï¼‰èƒœåˆ©ï¼Œä¸‹ä¸€è½®ç©å®¶2å…ˆæ‰‹
                        nextPlayer = 2;
                    } else {
                        // å¹³å±€ï¼Œä¸‹ä¸€è½®ç”±å½“å‰è½®æ¬¡çš„å…ˆæ‰‹çš„å¦ä¸€æ–¹å…ˆé€‰
                        nextPlayer = gameState.firstPlayer === 1 ? 2 : 1;
                    }
                }
            }
            
            // å…ˆå°†é€‰ä¸­çš„æˆ˜æœºæ·»åŠ åˆ°ç©å®¶çš„å·²é€‰æˆ˜æœºåˆ—è¡¨ä¸­
            if (currentSelections.length === 2) {
                // æ­£ç¡®è¯†åˆ«ç©å®¶1å’Œç©å®¶2çš„é€‰æ‹©ï¼Œä¸ä¾èµ–é€‰æ‹©é¡ºåº
                const player1Selection = currentSelections.find(selection => selection.playerId === 1);
                const player2Selection = currentSelections.find(selection => selection.playerId === 2);
                
                // åˆ›å»ºæˆ˜æœºå¯¹è±¡çš„æ·±æ‹·è´ï¼Œç¡®ä¿å·²é€‰æˆ˜æœºåˆ—è¡¨ä¸­çš„å¯¹è±¡ä¸å—å½±å“
                const player1Plane = JSON.parse(JSON.stringify(player1Selection.plane));
                const player2Plane = JSON.parse(JSON.stringify(player2Selection.plane));
                // æ·»åŠ åˆ°å·²é€‰æˆ˜æœºåˆ—è¡¨
                gameState.player1SelectedPlanes.push(player1Plane);
                gameState.player2SelectedPlanes.push(player2Plane);
                // æ›´æ–°å·²é€‰æˆ˜æœºå±•ç¤º
                renderSelectedPlanes();
            }
            
            // ä»æ¸¸æˆæ¿ä¸Šç§»é™¤å·²é€‰çš„æˆ˜æœº
            gameState.selectedPlanes.forEach(selection => {
                const { col, row } = selection;
                // ä»æ¸¸æˆæ¿ä¸Šç§»é™¤è¯¥ä½ç½®çš„æˆ˜æœº
                delete gameState.board[col][row].emoji;
                delete gameState.board[col][row].health;
                delete gameState.board[col][row].name;
                delete gameState.board[col][row].level;
                // æ ‡è®°ä¸ºå·²æ­ç¤ºå’Œå·²ç§»é™¤
                gameState.board[col][row].revealed = true;
                gameState.board[col][row].selected = false;
                gameState.board[col][row].removed = true;
            });
            
            // é‡ç½®æ‰€æœ‰å‰©ä½™æˆ˜æœºçš„selectedçŠ¶æ€å’Œä½ç½®
            gameState.board.forEach(column => {
                column.forEach(plane => {
                    // åªé‡ç½®è¿˜æœ‰æˆ˜æœºçš„ä½ç½®
                    if (plane.emoji) {
                        plane.selected = false;
                        // åˆ é™¤ä½ç½®ä¿¡æ¯ï¼Œè®©renderBoardé‡æ–°ç”Ÿæˆéšæœºä½ç½®
                        delete plane.position;
                    }
                });
            });
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.selectedPlanes = [];
            gameState.revealedCount += 2;
            // åªæœ‰åœ¨æ¸¸æˆæœªç»“æŸæ—¶æ‰å¢åŠ è½®æ¬¡
            if (gameState.revealedCount < gameState.totalPlanes) {
                gameState.roundCount++;
            }
            
            // è®¾ç½®ä¸‹ä¸€è½®çš„å…ˆæ‰‹ç©å®¶
            gameState.currentPlayer = nextPlayer;
            
            // è®°å½•å½“å‰è½®æ¬¡çš„å…ˆæ‰‹ç©å®¶
            gameState.firstPlayer = gameState.currentPlayer;
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€æ–‡æœ¬
            const playerName = gameState.currentPlayer === 1 ? '66å°æœ‹å‹' : '77å°æœ‹å‹';
            document.getElementById('game-status').textContent = `${playerName}ï¼Œè¯·é€‰æ‹©ä½ çš„æˆ˜æœº`;
            document.getElementById('round-count').textContent = gameState.roundCount;
            // é‡æ–°æ¸²æŸ“æ¸¸æˆæ¿ï¼Œæ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            renderBoard();
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (gameState.revealedCount >= gameState.totalPlanes) {
                setTimeout(() => {
                    endGame();
                }, 1000);
            }
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const text = document.getElementById('result-text');
            const player1Avatar = document.getElementById('player1-result-avatar');
            const player2Avatar = document.getElementById('player2-result-avatar');
            
            let winner = '';
            if (gameState.player1Score > gameState.player2Score) {
                winner = '66å°æœ‹å‹';
                title.textContent = `ğŸ‰ ${winner}è·èƒœï¼`;
                // æ˜¾ç¤º66å°æœ‹å‹å¤´åƒï¼Œéšè—77å°æœ‹å‹å¤´åƒ
                player1Avatar.classList.remove('hide');
                player2Avatar.classList.add('hide');
            } else if (gameState.player1Score < gameState.player2Score) {
                winner = '77å°æœ‹å‹';
                title.textContent = `ğŸ‰ ${winner}è·èƒœï¼`;
                // æ˜¾ç¤º77å°æœ‹å‹å¤´åƒï¼Œéšè—66å°æœ‹å‹å¤´åƒ
                player2Avatar.classList.remove('hide');
                player1Avatar.classList.add('hide');
            } else {
                title.textContent = 'ğŸ¤ å¹³å±€ï¼';
                // å¹³å±€æ—¶æ˜¾ç¤ºåŒæ–¹å¤´åƒ
                player1Avatar.classList.remove('hide');
                player2Avatar.classList.remove('hide');
            }
            
            text.textContent = `66å°æœ‹å‹: ${gameState.player1Score} èƒœ | 77å°æœ‹å‹: ${gameState.player2Score} èƒœ | æ€»è½®æ¬¡: ${gameState.roundCount}`;
            modal.classList.remove('hide');
            
            // æ’­æ”¾èƒœåˆ©éŸ³ä¹
            activateAudioContext();
            // ä½¿ç”¨é¡µé¢ä¸­å·²åˆ›å»ºçš„éŸ³é¢‘å…ƒç´ ï¼Œç¡®ä¿ä¸ç”¨æˆ·äº¤äº’å…³è”
            const victoryMusic = document.getElementById('victory-music');
            // é‡ç½®éŸ³é¢‘å¹¶æ’­æ”¾
            victoryMusic.currentTime = 0;
            victoryMusic.play().catch(error => {
                console.log('èƒœåˆ©éŸ³ä¹æ’­æ”¾å¤±è´¥:', error);
                // å°è¯•ä½¿ç”¨generateApplauseSoundä½œä¸ºåå¤‡æ–¹æ¡ˆ
                generateApplauseSound();
            });
        }
        
        // æ–°æ¸¸æˆ
        function newGame(totalPlanes = 10) {
            // ç¬¬ä¸€è½®éšæœºå†³å®šè°å…ˆé€‰
            const firstPlayer = Math.random() > 0.5 ? 1 : 2;
            
            // éšæœºé€‰æ‹©èƒŒæ™¯å›¾ç‰‡
            const skyImages = ['sky1.jpg', 'sky2.jpg', 'sky3.jpg'];
            const randomSky = skyImages[Math.floor(Math.random() * skyImages.length)];
            document.body.style.backgroundImage = `url('${randomSky}')`;
            
            // è®¡ç®—åˆé€‚çš„ç½‘æ ¼å¤§å°
            let boardSize = Math.ceil(Math.sqrt(totalPlanes));
            // ç¡®ä¿boardSizeä¸ºå¶æ•°
            if (boardSize % 2 !== 0) {
                boardSize++;
            }
            
            gameState = {
                board: initBoard(totalPlanes),
                player1Score: 0,
                player2Score: 0,
                currentPlayer: firstPlayer,
                firstPlayer: firstPlayer, // è®°å½•ç¬¬ä¸€è½®çš„å…ˆæ‰‹ç©å®¶
                selectedPlanes: [],
                roundCount: 1, // è½®æ¬¡ä»1å¼€å§‹
                revealedCount: 0,
                totalPlanes: totalPlanes,
                boardSize: boardSize,
                player1SelectedPlanes: [], // ç©å®¶1å·²é€‰æˆ˜æœº
                player2SelectedPlanes: []  // ç©å®¶2å·²é€‰æˆ˜æœº
            };
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('player1-score').textContent = '0';
            document.getElementById('player2-score').textContent = '0';
            document.getElementById('round-count').textContent = gameState.roundCount;
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€æ–‡æœ¬
            const playerName = firstPlayer === 1 ? '66å°æœ‹å‹' : '77å°æœ‹å‹';
            document.getElementById('game-status').textContent = `${playerName}ï¼Œè¯·é€‰æ‹©ä½ çš„æˆ˜æœº`;
            console.log('æ–°æ¸¸æˆåˆå§‹åŒ–ï¼Œå½“å‰ç©å®¶:', gameState.currentPlayer, 'æ˜¾ç¤ºæ–‡æœ¬:', document.getElementById('game-status').textContent);
            
            // éšè—æ¨¡æ€æ¡†
            document.getElementById('result-modal').classList.add('hide');
            document.getElementById('battle-modal').classList.add('hide');
            document.getElementById('battle-records-modal').classList.add('hide');
            
            // æ¸…ç©ºå·²é€‰æˆ˜æœºå±•ç¤º
            document.getElementById('player1-selected-list').innerHTML = '';
            document.getElementById('player2-selected-list').innerHTML = '';
            
            // æ¸²æŸ“æ¸¸æˆæ¿
            renderBoard();
        }
        
        // åˆå§‹åŒ–AudioContext - ç”¨äºå¤„ç†éŸ³æ•ˆ
        let audioContext = null;
        
        // æ¿€æ´»AudioContext - å¤„ç†æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾æ”¿ç­–
        function activateAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // æ¢å¤AudioContextï¼ˆå¦‚æœè¢«æŒ‚èµ·ï¼‰
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        // ç”Ÿæˆæ¬¢å‘¼å£°å’ŒæŒå£°éŸ³æ•ˆ
        function generateApplauseSound() {
            if (!audioContext) {
                activateAudioContext();
            }
            
            // åŸºæœ¬å‚æ•°
            const duration = 3.0; // éŸ³æ•ˆæŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
            const sampleRate = audioContext.sampleRate;
            const bufferLength = sampleRate * duration;
            
            // åˆ›å»ºä¸¤ä¸ªç¼“å†²åŒºï¼Œä¸€ä¸ªç”¨äºå·¦å£°é“ï¼Œä¸€ä¸ªç”¨äºå³å£°é“
            const buffer = audioContext.createBuffer(2, bufferLength, sampleRate);
            const leftChannel = buffer.getChannelData(0);
            const rightChannel = buffer.getChannelData(1);
            
            // ç”Ÿæˆæ¬¢å‘¼å£°ï¼ˆäººç¾¤å£°éŸ³ï¼‰
            generateCheerSound(leftChannel, rightChannel, duration, sampleRate);
            
            // ç”ŸæˆæŒå£°
            generateClapSound(leftChannel, rightChannel, duration, sampleRate);
            
            // åº”ç”¨ç®€å•çš„æ··å“æ•ˆæœ
            applyReverb(buffer);
            
            // é˜²æ­¢å‰Šæ³¢
            normalizeBuffer(buffer);
            
            // æ’­æ”¾éŸ³æ•ˆ
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
        }
        
        // ç”Ÿæˆæ¬¢å‘¼å£°ï¼ˆäººç¾¤å£°éŸ³ï¼‰
        function generateCheerSound(leftChannel, rightChannel, duration, sampleRate) {
            const bufferLength = sampleRate * duration;
            const cheerCount = 50; // æ¬¢å‘¼çš„äººæ•°
            
            for (let i = 0; i < cheerCount; i++) {
                // éšæœºæ—¶é—´ç‚¹
                const startTime = Math.random() * duration;
                const startSample = Math.floor(startTime * sampleRate);
                
                // æ¬¢å‘¼å£°æŒç»­æ—¶é—´ï¼ˆ0.5-1.5ç§’ï¼‰
                const cheerDuration = 0.5 + Math.random();
                const cheerSamples = Math.floor(cheerDuration * sampleRate);
                
                // éšæœºéŸ³é‡ï¼ˆ0.05-0.2ï¼‰
                const volume = 0.05 + Math.random() * 0.15;
                
                // å·¦å³å£°é“è½»å¾®å»¶è¿Ÿï¼Œåˆ›é€ ç«‹ä½“å£°æ•ˆæœ
                const leftDelay = Math.floor(Math.random() * 200);
                const rightDelay = Math.floor(Math.random() * 200);
                
                // äººå£°é¢‘ç‡èŒƒå›´ï¼ˆ100-800Hzï¼‰
                const baseFreq = 100 + Math.random() * 700;
                
                // ç”Ÿæˆæ¬¢å‘¼å£°æ³¢å½¢
                for (let j = 0; j < cheerSamples; j++) {
                    const t = j / cheerSamples;
                    // æ›´è‡ªç„¶çš„åŒ…ç»œçº¿
                    const envelope = t < 0.2 ? Math.sin(t * Math.PI / 0.4) : Math.exp(-(t - 0.2) / 0.3);
                    
                    // é¢¤éŸ³æ•ˆæœï¼ˆæ¨¡æ‹Ÿäººå£°é¢¤æŠ–ï¼‰
                    const vibratoFreq = 5 + Math.random() * 3;
                    const vibrato = 0.05 * Math.sin(2 * Math.PI * vibratoFreq * t);
                    
                    // äººå£°æ³¢å½¢ï¼ˆä½¿ç”¨é”¯é½¿æ³¢çš„è¿‘ä¼¼ï¼‰
                    const freq = baseFreq + vibrato * baseFreq;
                    const sample = (2 * Math.random() - 1) * 0.5; // è¿‘ä¼¼é”¯é½¿æ³¢
                    
                    // æ·»åŠ ä¸€äº›è°æ³¢
                    const harmonic1 = 0.3 * (2 * Math.random() - 1);
                    const harmonic2 = 0.2 * (2 * Math.random() - 1);
                    
                    // ç»„åˆå£°éŸ³
                    const cheerSound = (sample + harmonic1 + harmonic2) * volume * envelope;
                    
                    // å†™å…¥å·¦å³å£°é“ï¼Œæ·»åŠ è½»å¾®å»¶è¿Ÿ
                    if (startSample + j + leftDelay < bufferLength) {
                        leftChannel[startSample + j + leftDelay] += cheerSound;
                    }
                    if (startSample + j + rightDelay < bufferLength) {
                        rightChannel[startSample + j + rightDelay] += cheerSound;
                    }
                }
            }
        }
        
        // ç”ŸæˆæŒå£°
        function generateClapSound(leftChannel, rightChannel, duration, sampleRate) {
            const bufferLength = sampleRate * duration;
            const clapCount = 150; // æ‹æ‰‹æŒæ•°
            
            for (let i = 0; i < clapCount; i++) {
                // éšæœºæ—¶é—´ç‚¹
                const startTime = Math.random() * duration;
                const startSample = Math.floor(startTime * sampleRate);
                
                // æ‹æ‰‹å£°æŒç»­æ—¶é—´ï¼ˆ0.05-0.15ç§’ï¼‰
                const clapDuration = 0.05 + Math.random() * 0.1;
                const clapSamples = Math.floor(clapDuration * sampleRate);
                
                // éšæœºéŸ³é‡ï¼ˆ0.1-0.3ï¼‰
                const volume = 0.1 + Math.random() * 0.2;
                
                // å·¦å³å£°é“è½»å¾®å»¶è¿Ÿï¼Œåˆ›é€ ç«‹ä½“å£°æ•ˆæœ
                const leftDelay = Math.floor(Math.random() * 100);
                const rightDelay = Math.floor(Math.random() * 100);
                
                // ç”Ÿæˆæ‹æ‰‹å£°æ³¢å½¢
                for (let j = 0; j < clapSamples; j++) {
                    const t = j / clapSamples;
                    // æ›´è‡ªç„¶çš„åŒ…ç»œçº¿ï¼ˆå¿«é€Ÿä¸Šå‡ï¼Œå¿«é€Ÿè¡°å‡ï¼‰
                    const envelope = Math.exp(-t / 0.02) * Math.exp(-(clapSamples - j) / 100);
                    
                    // æ‹æ‰‹å£°ç”±å†²å‡»å£°å’Œä½é¢‘å…±é¸£ç»„æˆ
                    // 1. å†²å‡»å£°ï¼ˆé«˜é¢‘å™ªå£°ï¼‰
                    const impactNoise = (Math.random() - 0.5) * 0.8;
                    
                    // 2. ä½é¢‘å…±é¸£ï¼ˆç±»ä¼¼é¼“å£°ï¼‰
                    const resonanceFreq = 150 + Math.random() * 100;
                    const resonance = Math.sin(2 * Math.PI * resonanceFreq * t) * 0.3;
                    
                    // 3. ä¸­é¢‘æˆåˆ†
                    const midFreq = 800 + Math.random() * 400;
                    const mid = Math.sin(2 * Math.PI * midFreq * t) * 0.2;
                    
                    // ç»„åˆå£°éŸ³
                    const clapSound = (impactNoise + resonance + mid) * volume * envelope;
                    
                    // å†™å…¥å·¦å³å£°é“ï¼Œæ·»åŠ è½»å¾®å»¶è¿Ÿ
                    if (startSample + j + leftDelay < bufferLength) {
                        leftChannel[startSample + j + leftDelay] += clapSound;
                    }
                    if (startSample + j + rightDelay < bufferLength) {
                        rightChannel[startSample + j + rightDelay] += clapSound;
                    }
                }
            }
        }
        
        // åº”ç”¨ç®€å•çš„æ··å“æ•ˆæœ
        function applyReverb(buffer) {
            const sampleRate = buffer.sampleRate;
            const leftChannel = buffer.getChannelData(0);
            const rightChannel = buffer.getChannelData(1);
            
            // ç®€å•çš„å»¶è¿Ÿæ··å“ï¼ˆå¤šä¸ªå»¶è¿Ÿçº¿ï¼‰
            const delayTimes = [0.05, 0.1, 0.15, 0.2]; // å¤šä¸ªå»¶è¿Ÿæ—¶é—´
            const feedbacks = [0.2, 0.15, 0.1, 0.05]; // å¯¹åº”çš„åé¦ˆå¼ºåº¦
            
            // å¯¹æ¯ä¸ªå»¶è¿Ÿçº¿åº”ç”¨æ··å“
            delayTimes.forEach((delayTime, index) => {
                const delaySamples = Math.floor(delayTime * sampleRate);
                const feedback = feedbacks[index];
                
                // å¯¹å·¦å³å£°é“åˆ†åˆ«åº”ç”¨å»¶è¿Ÿ
                for (let i = delaySamples; i < leftChannel.length; i++) {
                    leftChannel[i] += leftChannel[i - delaySamples] * feedback;
                    rightChannel[i] += rightChannel[i - delaySamples] * feedback;
                }
            });
        }
        
        // å½’ä¸€åŒ–ç¼“å†²åŒºï¼Œé˜²æ­¢å‰Šæ³¢
        function normalizeBuffer(buffer) {
            const leftChannel = buffer.getChannelData(0);
            const rightChannel = buffer.getChannelData(1);
            
            // æ‰¾åˆ°æœ€å¤§æŒ¯å¹…
            let maxAmplitude = 0;
            for (let i = 0; i < leftChannel.length; i++) {
                maxAmplitude = Math.max(maxAmplitude, Math.abs(leftChannel[i]), Math.abs(rightChannel[i]));
            }
            
            // å½’ä¸€åŒ–åˆ°0.7çš„æœ€å¤§æŒ¯å¹…ï¼Œä¿ç•™ä¸€äº›ä½™é‡
            if (maxAmplitude > 0) {
                const gain = 0.7 / maxAmplitude;
                for (let i = 0; i < leftChannel.length; i++) {
                    leftChannel[i] *= gain;
                    rightChannel[i] *= gain;
                }
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        document.getElementById('continue-btn').addEventListener('click', () => {
            activateAudioContext();
            continueGame();
        });
        
        // æŸ¥çœ‹æˆ˜å†µ
        document.getElementById('view-battle-records').addEventListener('click', () => {
            activateAudioContext();
            showBattleRecords();
        });
        
        // æ˜¾ç¤ºæˆ˜å†µè¯¦æƒ…
        function showBattleRecords() {
            const recordsModal = document.getElementById('battle-records-modal');
            const recordsList = document.getElementById('battle-records-list');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            recordsList.innerHTML = '';
            
            // è·å–ç©å®¶å·²é€‰æˆ˜æœºåˆ—è¡¨
            const player1Planes = gameState.player1SelectedPlanes;
            const player2Planes = gameState.player2SelectedPlanes;
            
            // ç”Ÿæˆæ¯è½®æˆ˜å†µ
            for (let round = 0; round < player1Planes.length; round++) {
                const roundRecord = document.createElement('div');
                roundRecord.className = 'round-record';
                
                // è½®æ¬¡æ ‡é¢˜
                const roundTitle = document.createElement('div');
                roundTitle.className = 'round-title';
                roundTitle.textContent = `ç¬¬${round + 1}è½®`;
                roundRecord.appendChild(roundTitle);
                
                // ç©å®¶é€‰æ‹©åŒºåŸŸ
                const selections = document.createElement('div');
                selections.className = 'player-selections';
                
                // æ¯”è¾ƒè¡€é‡ï¼Œç¡®å®šæœ¬è½®èƒœè€…
                const player1Health = player1Planes[round].health;
                const player2Health = player2Planes[round].health;
                const winner = player1Health > player2Health ? 1 : player2Health > player1Health ? 2 : 0;
                
                // ç©å®¶1é€‰æ‹©
                const player1Selection = document.createElement('div');
                player1Selection.className = 'player-selection';
                player1Selection.innerHTML = `
                    <div class="player-name" style="color: #ff6b6b;">
                        ${winner === 1 ? 'ğŸ† ' : ''}66å°æœ‹å‹
                    </div>
                    <div class="plane-info">
                        <div class="plane-emoji">${player1Planes[round].emoji}</div>
                        <div class="plane-details">
                            <div>${player1Planes[round].name}</div>
                            <div>è¡€é‡: ${player1Planes[round].health}</div>
                            <div>ç­‰çº§: Lv.${player1Planes[round].level}</div>
                        </div>
                    </div>
                `;
                selections.appendChild(player1Selection);
                
                // ç©å®¶2é€‰æ‹©
                const player2Selection = document.createElement('div');
                player2Selection.className = 'player-selection';
                player2Selection.innerHTML = `
                    <div class="player-name" style="color: #4ecdc4;">
                        ${winner === 2 ? 'ğŸ† ' : ''}77å°æœ‹å‹
                    </div>
                    <div class="plane-info">
                        <div class="plane-emoji">${player2Planes[round].emoji}</div>
                        <div class="plane-details">
                            <div>${player2Planes[round].name}</div>
                            <div>è¡€é‡: ${player2Planes[round].health}</div>
                            <div>ç­‰çº§: Lv.${player2Planes[round].level}</div>
                        </div>
                    </div>
                `;
                selections.appendChild(player2Selection);
                
                roundRecord.appendChild(selections);
                recordsList.appendChild(roundRecord);
            }
            
            // æ˜¾ç¤ºæˆ˜å†µæ¨¡æ€æ¡†
            recordsModal.classList.remove('hide');
        }
        
        // å…³é—­æˆ˜å†µè¯¦æƒ…å¹¶ç»“æŸæ¸¸æˆ
        document.getElementById('end-game').addEventListener('click', () => {
            // éšè—æ‰€æœ‰æ¨¡æ€æ¡†ï¼ŒçœŸæ­£ç»“æŸæ¸¸æˆ
            const recordsModal = document.getElementById('battle-records-modal');
            recordsModal.classList.add('hide');
            const resultModal = document.getElementById('result-modal');
            resultModal.classList.add('hide');
            // å¯ä»¥é€‰æ‹©é‡ç½®æ¸¸æˆçŠ¶æ€æˆ–ä¿æŒå½“å‰çŠ¶æ€ï¼Œè¿™é‡Œé€‰æ‹©éšè—æ¨¡æ€æ¡†å³å¯
        });
        
        // ä»æˆ˜å†µè¯¦æƒ…é‡æ–°å¼€å§‹æ¸¸æˆ
        document.getElementById('play-again-from-records').addEventListener('click', () => {
            activateAudioContext();
            const recordsModal = document.getElementById('battle-records-modal');
            recordsModal.classList.add('hide');
            newGame(gameState.totalPlanes); // ä½¿ç”¨å½“å‰æ¸¸æˆçš„æˆ˜æœºæ€»æ•°å¼€å§‹æ–°æ¸¸æˆ
        });
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        document.getElementById('play-again')?.addEventListener('click', () => {
            activateAudioContext();
            newGame(gameState.totalPlanes); // ä½¿ç”¨å½“å‰æ¸¸æˆçš„æˆ˜æœºæ€»æ•°å¼€å§‹æ–°æ¸¸æˆ
        });
        
        // æ¸¸æˆå¤§å°é€‰æ‹©äº‹ä»¶
        document.querySelectorAll('.size-option').forEach(btn => {
            btn.addEventListener('click', () => {
                activateAudioContext();
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                document.querySelectorAll('.size-option').forEach(b => b.classList.remove('active'));
                // ä¸ºå½“å‰æŒ‰é’®æ·»åŠ activeç±»
                btn.classList.add('active');
                
                const totalPlanes = parseInt(btn.dataset.planes);
                newGame(totalPlanes);
            });
        });
        
        // æ·»åŠ å…¨å±€äº¤äº’äº‹ä»¶ï¼Œç¡®ä¿AudioContextåœ¨ä»»ä½•ç”¨æˆ·äº¤äº’æ—¶éƒ½èƒ½è¢«æ¿€æ´»
        // ç§»é™¤onceé€‰é¡¹ï¼Œç¡®ä¿æ¯æ¬¡äº¤äº’éƒ½èƒ½å°è¯•æ¿€æ´»AudioContext
        document.addEventListener('click', activateAudioContext);
        document.addEventListener('keydown', activateAudioContext);
        document.addEventListener('touchstart', activateAudioContext);
        document.addEventListener('touchend', activateAudioContext);
        document.addEventListener('mousedown', activateAudioContext);
        document.addEventListener('mouseup', activateAudioContext);
        
        // æ£€æµ‹è®¾å¤‡ç±»å‹å¹¶è‡ªåŠ¨è°ƒæ•´å±å¹•æ–¹å‘
        function detectDeviceAndAdjustOrientation() {
            // æ£€æµ‹æ˜¯å¦ä¸ºæ‰‹æœºè®¾å¤‡
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                console.log('æ£€æµ‹åˆ°æ‰‹æœºè®¾å¤‡ï¼Œå°è¯•åˆ‡æ¢åˆ°æ¨ªå±æ¨¡å¼...');
                
                // å°è¯•ä½¿ç”¨Screen Orientation APIè¯·æ±‚æ¨ªå±æ¨¡å¼
                if (screen.orientation && screen.orientation.lock) {
                    try {
                        screen.orientation.lock('landscape').then(function() {
                            console.log('æ¨ªå±æ¨¡å¼åˆ‡æ¢æˆåŠŸ');
                        }).catch(function(error) {
                            console.log('æ— æ³•é”å®šæ¨ªå±æ¨¡å¼ï¼ˆç”¨æˆ·å¯èƒ½æ‹’ç»äº†è¯·æ±‚ï¼‰:', error);
                        });
                    } catch (e) {
                        console.log('æ¨ªå±æ¨¡å¼é”å®šå¤±è´¥:', e);
                    }
                } else {
                    console.log('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒScreen Orientation API');
                }
            }
        }
        
        // å·²é€‰æˆ˜æœºåŒºåŸŸåˆ‡æ¢åŠŸèƒ½
        function initSelectedPlanesToggle() {
            const selectedPlanes = document.querySelector('.selected-planes');
            const banner = document.getElementById('selected-planes-banner');
            const content = document.getElementById('selected-planes-content');
            
            // ç‚¹å‡»æ¨ªå¹…åˆ‡æ¢æ˜¾ç¤º/éšè—
            banner.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                selectedPlanes.classList.toggle('expanded');
            });
            
            // ç‚¹å‡»å†…å®¹åŒºåŸŸå†…éƒ¨ä¸å…³é—­
            content.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            });
            
            // ç‚¹å‡»å±å¹•å…¶ä»–åŒºåŸŸå…³é—­
            document.addEventListener('click', function() {
                selectedPlanes.classList.remove('expanded');
            });
        }
        
        // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ£€æµ‹è®¾å¤‡å¹¶åˆå§‹åŒ–åŠŸèƒ½
        window.addEventListener('load', function() {
            detectDeviceAndAdjustOrientation();
            initSelectedPlanesToggle();
        });
        
        // åˆå§‹åŒ–æ¸¸æˆï¼Œé»˜è®¤10æ¶æˆ˜æœº
        document.querySelector('.size-option[data-planes="10"]').classList.add('active');
        newGame(10);
    </script>
</body>
</html>
